# Database Schema Documentation

This project uses **MongoDB** (via Mongoose) to store metadata and **Supabase Storage** to store binary files.

## Collection: `secrets`

The main collection storing both text secrets and file metadata.

### Model Definition

| Field | Type | Required | Default | Description |
| :--- | :--- | :--- | :--- | :--- |
| `_id` | ObjectId | Yes | Auto | Unique identifier for the secret. Used in the access link. |
| `type` | String | Yes | `'text'` | Enum: `['text', 'file']`. Determines if the secret is a text string or a file upload. |
| `content` | String | No | - | **(Text Only)** The actual secret text content. |
| `fileUrl` | String | No | - | **(File Only)** The public download URL generated by Supabase. |
| `storagePath` | String | No | - | **(File Only)** The internal path in the Supabase bucket (e.g., `1715682_myimage.png`). Used for deletion. |
| `fileName` | String | No | - | **(File Only)** The original filename uploaded by the user. |
| `mimeType` | String | No | - | **(File Only)** The MIME type of the file (e.g., `image/png`). |
| `password` | String | No | `''` | Optional password for access. Stored as plain text for this demo (production apps should hash this). |
| `deleteToken` | String | Yes | - | A random hex string generated upon creation. Required to manually delete the secret before expiration. |
| `views` | Number | Yes | `0` | The current number of times the secret has been accessed. |
| `maxViews` | Number | Yes | `1` | The maximum number of allowed views before the secret is auto-deleted. |
| `createdAt` | Date | Yes | `Date.now` | Timestamp of creation. |
| `expiresAt` | Date | Yes | - | The absolute timestamp when the secret becomes invalid. |

### JSON Document Examples

#### 1. Text Secret
```json
{
  "_id": "64e5f7a1b2c3d4e5f6g7h8i9",
  "type": "text",
  "content": "My super secret password is: hunter2",
  "password": "",
  "deleteToken": "a1b2c3d4e5f6g7h8",
  "views": 0,
  "maxViews": 5,
  "createdAt": "2023-10-27T10:00:00.000Z",
  "expiresAt": "2023-10-27T11:00:00.000Z",
  "__v": 0
}
```

#### 2. File Secret
```json
{
  "_id": "64e5f7a1b2c3d4e5f6g7h8j0",
  "type": "file",
  "fileUrl": "https://xyz.supabase.co/storage/v1/object/public/secret-share/169839_contract.pdf",
  "storagePath": "169839_contract.pdf",
  "fileName": "contract.pdf",
  "mimeType": "application/pdf",
  "password": "secret_access_code",
  "deleteToken": "f6g7h8i9a1b2c3d4",
  "views": 1,
  "maxViews": 1,
  "createdAt": "2023-10-27T10:30:00.000Z",
  "expiresAt": "2023-10-27T11:30:00.000Z",
  "__v": 0
}
```

---

## Storage Architecture

While metadata is stored in MongoDB, actual files are offloaded to **Supabase Object Storage**.

*   **Bucket Name**: `secret-share`
*   **Permissions**: Public Read (Access controlled via Obscurity/URL knowledge), Service Role Write/Delete.

### Data Flow for Files
1.  **Upload**: Backend receives file $\rightarrow$ Uploads to Supabase $\rightarrow$ Gets `publicUrl` $\rightarrow$ Saves metadata to MongoDB.
2.  **Delete**: Backend finds MongoDB record $\rightarrow$ Reads `storagePath` $\rightarrow$ Calls Supabase API to delete file $\rightarrow$ Deletes MongoDB record.
